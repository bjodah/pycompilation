pipeline:
  build:
    image: bjodah/bjodahimg20dev:v1.0.3
    environment:
      - PYCVODES_LAPACK=lapack,blas
      - PYCVODES_SUNDIALS_LIBS=sundials_cvodes,sundials_nvecserial,sundials_sunlinsollapackdense,sundials_sunlinsollapackband,sundials_sunlinsolklu
      - PYCVODES_NO_KLU=0
      - LD_LIBRARY_PATH=/usr/lib/x86_64-linux-gnu
      - CPATH=/usr/include/suitesparse
      - CPLUS_INCLUDE_PATH=/opt/boost_1_72_p/include
      - SUNDBASE=/opt/sundials-5.1.0-klu-lapack
    commands:
      - export CPATH=$SUNDBASE/include:$CPATH
      - export LIBRARY_PATH=$SUNDBASE/lib:$LIBRARY_PATH
      - export LD_LIBRARY_PATH=$SUNDBASE/lib:$LD_LIBRARY_PATH
      - bash -c '[[ $(python3 setup.py --version) =~ ^[0-9]+.* ]]'
      - ./scripts/ci.sh pycompilation
      - PATH=$HOME/.local/bin:$PATH ./scripts/generate_docs.sh
      - ./scripts/prepare_deploy.sh

  deploy:
    image: drillster/drone-rsync
    when:
      event: [push]
    hosts: [ "hera.physchem.kth.se" ]  # 127.0.0.1  192.168.1.99 davycrockett.mooo.com
    port: 22
    user: pycompilation
    secrets: [ rsync_key ]  # secret only set fro event "push" not "pull_request"
    source: ./deploy/public_html
    target: ~/
